<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Four Pets Citizens</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
          integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>
    <script
            src="http://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="Javascript/Navigation.js"></script>
    <link rel="stylesheet" href="css/styles.css" type="text/css">
</head>
<body class="vetBack">

<!--Navigation of the vet interface-->
<nav>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="register-tab" data-toggle="tab" href="#register" role="tab"
               aria-controls="register" aria-selected="true">Crear Visita</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="find-tab" data-toggle="tab" href="#find" role="tab" aria-controls="find"
               aria-selected="false">Tabla de Visitas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="Upuser-tab" data-toggle="tab" href="#Upuser" role="tab" aria-controls="Upuser"
               aria-selected="false">Cambiar datos de Veterinaria</a>
        </li>
    </ul>
</nav>

<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="register" role="tabpanel" aria-labelledby="register-tab" align="center">
        <div class="configureStyleMainForms">

            <!--Form to create a new visit in the vet-->
            <form action="CreatVisitsform" autocomplete="off" id="formVC" name="formVC">
                <fieldset>
                    <legend> Formulario de Registro de Visitas</legend>
                    <label for="CreatAt">Fecha de la visita: </label><br>
                    <input type="date" name="CreatAt" id="CreatAt" required>
                    <br>
                    <br>
                    <label for="type">Motivo de la visita: </label><br>
                    <select name="type" id="type" onchange="controlMicrochip()" required>
                        <option value="" selected="selected">Seleccione</option>
                        <option value="2">Esterilización</option>
                        <option value="3">Implantación de microchip</option>
                        <option value="4">Vacunación</option>
                        <option value="5">Desparasitación</option>
                        <option value="6">Urgencia</option>
                        <option value="7">Control</option>
                    </select>
                    <br>
                    <br>
                    <label for="microchip">Microchip de Mascota</label><br>
                    <input type="text" name="microchip" size="30" id="microchip" placeholder="Ej: 123456789" disabled>

                    <br>
                    <br>
                    <label for="description">Descripción de la visita</label><br>
                    <input type="text" name="description" size="30" id="description"
                           placeholder="Ej: Cita de control de esterilización">
                    <br>
                    <br>
                    <label for="petId">Identificación de Mascota</label><br>
                    <input type="text" name="petId" size="30" id="petId" placeholder="Ej: 123456789">
                    <br>
                    <br>
                    <p align="center">
                        <button type="button" id="Cpets">Crear Caso</button>
                    </p>
                </fieldset>
            </form>
        </div>
    </div>
    <div class="tab-pane fade" id="find" role="tabpanel" aria-labelledby="find-tab" align="center">
        <div class="configureStyleMainBox">
            <h3 class="titles">Busqueda de visitas por fechas y nombre de la mascota</h3>
            <h5>Filtrar</h5>

            <!-- Filters of Date and pet name to search the visits of this pet-->
            <form name="formTCV" id="formTCV">
                <label for="Date1"> Primer rango de fecha</label><br>
                <input type="Date" name="Date1" size="30" id="Date1" required>
                <br>
                <br>
                <label for="Date2"> Segundo rango de fecha</label><br>
                <input type="Date" name="Date2" size="30" id="Date2" required>
                <br>
                <br>
                <label for="PetName">Nombre de la mascota</label><br>
                <input type="text" name="PetName" size="30" id="PetName" required>
                <br>
                <br>
                <button class="btn btn-rounded btn-primary" id="filter" type="button">Filtrar</button>
            </form>

            <div class="TableVisit" id="TableVisit">
                <h2 class="titles">Tabla de Visitas de Mascotas</h2>

                <!--Table that shows the visits of a pet in the vet-->
                <table id="myTablePets" class="table table-fluid">
                    <thead>
                    <tr>
                        <th scope="col">Actualizar</th>
                        <th scope="col">Identificación de la Veterinaria</th>
                        <th scope="col">Identificación de la Mascota</th>
                        <th scope="col">Fecha de la visita</th>
                        <th scope="col">Tipo de la visita</th>
                        <th scope="col">Descripción</th>
                    </tr>
                    </thead>
                </table>
            </div>

        </div>
    </div>
    <div class="tab-pane fade" id="Upuser" role="tabpanel" aria-labelledby="Upuser-tab" align="center">
        <div class="configureStyleMainForms">

            <!--Form to update the vet's user data-->
            <form name="formUser" autocomplete="off" id="formUser">
                <fieldset>
                    <legend> Formulario de Actualizar datos de la Veterinaria</legend>
                    <br>
                    <label for="neighborhoodUser">Seleccione la localidad:</label><br>
                    <select id="neighborhoodUser" name="neighborhoodUser" required>
                        <option value="" selected="selected">Seleccione</option>
                        <option value="2">Usaquen</option>
                        <option value="3">Chapinero</option>
                        <option value="4">Santa Fe</option>
                        <option value="5">San Cristobal</option>
                        <option value="6">Usme</option>
                        <option value="7">Tunjuelito</option>
                        <option value="8">Bosa</option>
                        <option value="9">Kennedy</option>
                        <option value="10">Fontibon</option>
                        <option value="11">Engativa</option>
                        <option value="12">Suba</option>
                        <option value="13">Barrios Unidos</option>
                        <option value="14">Teusaquillo</option>
                        <option value="15">Los Martires</option>
                        <option value="16">Antonio Nariño</option>
                        <option value="17">Puente Aranda</option>
                        <option value="18">La Candelaria</option>
                        <option value="19">Uribe</option>
                        <option value="20">Ciudad Bolivar</option>
                        <option value="21">Sumapaz</option>
                        <option value="22">Municipios aledaños</option>
                    </select>
                    <br>
                    <br>
                    <label for="addressUser">Digite la dirección:</label><br>
                    <input type="text" name="addressUser" size="30" id="addressUser" placeholder="Ej: Cr 7 # 100 - 10"
                           required>
                    <br>
                    <br>

                    <p align="center">
                        <button type="button" id="Uuser">Actualizar datos</button>
                    </p>
                </fieldset>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
    var visitButton = document.getElementById("Cpets");
    var vetButton = document.getElementById("Uuser");

    /**
     * Function that validates the implantation of a microchip in a pet
     */
    function controlMicrochip() {
        var type = document.formVC.type[document.formVC.type.selectedIndex].text;
        if (type == "Implantación de microchip") {
            var microchip = document.getElementById("microchip");
            microchip.disabled = false;
        } else {
            var microchip = document.getElementById("microchip");
            microchip.disabled = true;
        }
    }

    /**
     * Find the user in the url
     * @returns {string}
     */
    function findUsername() {
        var url = window.location.href
        var part = url.split("?");
        return (part[1])
    }

    /**
     * Take and send it the data to the backend and create the visit
     */
    visitButton.onclick = function () {
        var username = findUsername();
        var pet_id = Number(document.getElementById("petId").value);
        var create_at = document.getElementById("CreatAt").value;
        var type = document.formVC.type[document.formVC.type.selectedIndex].text
        var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/vet/' + username + '/visits';

        //If the visit is for implantation microchip, take the microchip value and send it
        if (type == "Implantación de microchip") {
            var microchip = Number(document.getElementById("microchip").value);
            type = "implantación de microchip";
            if(isNaN(microchip)||isNaN(pet_id)||type=="Seleccione"){
                alert("Los datos ingresados son incorrectos");
                return;
            }
            var data = {
                "created_at": create_at.replace(/^(\d{4})-(\d{2})-(\d{2})$/g, '$3/$2/$1'),
                "type": type,
                "microchip": microchip,
                "description": document.getElementById("description").value,
                "pet_id": pet_id
            };

            //Send and create a post method in the rest backend
            fetch(url, {
                method: 'POST',
                body: JSON.stringify(data), // data can be `string` or {object}!
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => res.text())
                .then(response => showAlert(response));
        } else {
            if(isNaN(pet_id)||type=="Seleccione"){
                alert("Los datos ingresados son incorrectos");
                return;
            }
            var data = {
                "created_at": create_at.replace(/^(\d{4})-(\d{2})-(\d{2})$/g, '$3/$2/$1'),
                "type": type,
                "description": document.getElementById("description").value,
                "pet_id": pet_id
            };
            fetch(url, {
                method: 'POST',
                body: JSON.stringify(data), // data can be `string` or {object}!
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => res.text())
                .then(response => showAlert(response));
        }
    }

    /**
     * Function that sends a message if the visit creation is successful
     * @param res
     */
    function showAlert(res) {
        if (res === "Se ha creado exitosamente la visita!") {
            alert("Se ha creado exitosamente la visita!");
        } else {
            alert(res.toString());
        }
        location.reload();
    }

    /**
     * Update the dat of the vet
     */
    vetButton.onclick = function () {
        var username = findUsername();
        var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/vet/' + username;
        if(document.formUser.neighborhoodUser[document.formUser.neighborhoodUser.selectedIndex].text=="Seleccione"){
            alert("Es necesario selecionar una localidad");
            return;
        }

        var data = {
            "username": username,
            "password": null,
            "email": null,
            "name": null,
            "address": document.getElementById("addressUser").value,
            "neighborhood": document.formUser.neighborhoodUser[document.formUser.neighborhoodUser.selectedIndex].text
        };

        //Send and create a put method in the rest backend
        fetch(url, {
            method: 'PUT',
            body: JSON.stringify(data), // data can be `string` or {object}!
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(res => res.text())
            .then(response => console.log('Success:', response));
        alert("Se actualizaron los datos ");
        location.reload();
    }

</script>

</body>
</html>